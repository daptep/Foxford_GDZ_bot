name: Deploy GDZ-Bot (Manual)

on:
  push:
    branches: [ "main" ] # Запускать при пуше в main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # Сборщик будет на Ubuntu

    steps:
    # 1. Получаем код из репозитория
    - uses: actions/checkout@v4

    # 2. Настраиваем .NET 8 (версия из вашего .csproj)
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # 3. Собираем проект
    - name: Build & Publish
      run: dotnet publish -c Release -o ./publish

    # 4. Настраиваем SSH-ключ и Known Hosts (вручную)
    - name: Setup SSH
      run: |
        # Создаем папку для ssh
        mkdir -p ~/.ssh/
        
        # Записываем приватный ключ из секрета GitHub в файл
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_gdz_bot
        
        # Устанавливаем правильные права (ОЧЕНЬ ВАЖНО)
        chmod 600 ~/.ssh/id_gdz_bot
        
        # Автоматически добавляем отпечаток сервера в known_hosts
        # Это заменяет ручной ввод "yes" при первом подключении
        ssh-keyscan -H -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    # НОВЫЙ ШАГ: Устанавливаем rsync
    - name: Install rsync
      run: sudo apt-get update && sudo apt-get install -y rsync

    # 5. Копируем файлы на сервер (ручной rsync)
    - name: Deploy to Server (rsync)
      run: |
        rsync -avz --delete \
          --exclude 'foxford_answers.db' \
          --exclude 'foxford_answers.db-wal' \
          --exclude 'foxford_answers.db-shm' \
          --exclude 'task_images/' \
          -e "ssh -i ~/.ssh/id_gdz_bot -p ${{ secrets.SERVER_PORT }}" \
          ./publish/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/gdz-bot

    # 6. Перезапускаем службу на сервере (ручной ssh)
    - name: Restart Service
      run: |
        ssh -i ~/.ssh/id_gdz_bot -p ${{ secrets.SERVER_PORT }} \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          "sudo systemctl restart gdz-bot && echo 'Service restarted.' && sudo systemctl status gdz-bot --no-pager"

    # 7. Очистка (на всякий случай)
    - name: Cleanup SSH Key
      run: |
        rm -f ~/.ssh/id_gdz_bot